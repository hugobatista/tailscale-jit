name: Expire All JIT Access
on:
  workflow_dispatch:
    inputs:
      access_type:
        description: 'Custom attribute name (without "custom:" prefix) or "all" to revoke all JIT attributes'
        default: 'ssh'
        required: true
        type: choice
        # NOTE: if you update this list, make sure to also update the validation logic in the workflow and the README documentation
        options:
          - ssh
          - arr
          - monitoring
          - admin
          - all

jobs:
  expire-all:
    runs-on: ubuntu-latest
    steps:

      - name: Validate access type and map it into full attribute name
        id: validate-access-type
        run: |

          # validate access type is on the allowed list
          # NOTE: if you updated the list of access types in the workflow_dispatch inputs, make sure to also update this validation logic and the README documentation
          if [[ ! "ssh arr monitoring admin all" =~ "${{ github.event.inputs.access_type }}" ]]; then
            echo "::error::Invalid access type. Must be one of: ssh, arr, monitoring, admin."
            exit 1
          fi
          IS_ALL_MODE="false"
          if [ "${{ github.event.inputs.access_type }}" != "all" ]; then
            ATTRIBUTE="custom:${{ github.event.inputs.access_type }}_jit_granted"
          else
            ATTRIBUTE=""
            IS_ALL_MODE="true"
          fi

          echo "attribute=$ATTRIBUTE" >> $GITHUB_OUTPUT
          echo "is_all_mode=$IS_ALL_MODE" >> $GITHUB_OUTPUT
          if [ "$IS_ALL_MODE" = "true" ]; then
            echo "‚úÖ Access type to be revoked: ALL JIT attributes"
          else
            echo "‚úÖ Access type to be revoked: $ATTRIBUTE"
          fi


      - name: Get Tailscale OAuth token
        id: oauth
        env:
          TS_OAUTH_CLIENT_ID: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          TS_OAUTH_CLIENT_SECRET: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
        run: |
          TOKEN_RESPONSE=$(curl -s -X POST \
            "https://api.tailscale.com/api/v2/oauth/token" \
            -d "client_id=$TS_OAUTH_CLIENT_ID" \
            -d "client_secret=$TS_OAUTH_CLIENT_SECRET" \
            -d "scope=devices:core:read devices:posture_attributes")
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          echo "::add-mask::$ACCESS_TOKEN"
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "‚úÖ OAuth token obtained"
      
      - name: Expire all JIT access
        id: expire
        run: |
          set +e  # Don't exit on errors; handle them manually

          TS_ACCESS_TOKEN="${{ steps.oauth.outputs.access_token }}"
          ATTRIBUTE="${{ steps.validate-access-type.outputs.attribute }}"
          IS_ALL_MODE="${{ steps.validate-access-type.outputs.is_all_mode }}"
          
          echo "üîç Fetching all devices in tailnet..."
          DEVICES=$(curl -s -H "Authorization: Bearer $TS_ACCESS_TOKEN" \
            "https://api.tailscale.com/api/v2/tailnet/-/devices")
          
          # Get all device IDs
          ALL_DEVICE_IDS=$(echo "$DEVICES" | jq -r '.devices[].id')
          
          if [ -z "$ALL_DEVICE_IDS" ]; then
            echo "‚ÑπÔ∏è No devices found in tailnet"
            exit 0
          fi
          
          # Build attributes array based on mode
          if [ "$IS_ALL_MODE" = "true" ]; then
            ATTRIBUTES=("custom:ssh_jit_granted" "custom:arr_jit_granted" "custom:monitoring_jit_granted" "custom:admin_jit_granted")
          else
            ATTRIBUTES=("$ATTRIBUTE")
          fi
          
          REVOKED_COUNT=0
          FAILED_COUNT=0
          SKIPPED_COUNT=0
          REVOKED_DEVICES=""
          
          while IFS= read -r DEVICE_ID; do
            [ -z "$DEVICE_ID" ] && continue
            
            # Get hostname for this device. use the short hostname (before the first dot) since its the more reliable way
            HOSTNAME=$(echo "$DEVICES" | jq -r --arg id "$DEVICE_ID" '.devices[] | select(.id == $id) | .name | split(".")[0]' 2>/dev/null || echo "unknown")

            echo "::add-mask::$HOSTNAME"
            
            echo "üîç Checking device $HOSTNAME"
            DEVICE_REVOKED_ATTRS=""
            DEVICE_REVOKED_ACCESS_TYPES=""
            
            for ATTR in "${ATTRIBUTES[@]}"; do
              RESPONSE=$(curl -s -w "%{http_code}" -X DELETE \
                "https://api.tailscale.com/api/v2/device/$DEVICE_ID/attributes/$ATTR" \
                -H "Authorization: Bearer $TS_ACCESS_TOKEN")
              
              HTTP_CODE="${RESPONSE: -3}"
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "  ‚úÖ Revoked: $ATTR"
                REVOKED_COUNT=$((REVOKED_COUNT + 1))
                if [ -z "$DEVICE_REVOKED_ATTRS" ]; then
                  DEVICE_REVOKED_ATTRS="$ATTR"
                else
                  DEVICE_REVOKED_ATTRS="$DEVICE_REVOKED_ATTRS, $ATTR"
                fi
                # Map attribute back to access type for reporting
                ACCESS_TYPE_NAME=$(echo "$ATTR" | sed -E 's/custom:(.*)_jit_granted/\1/')
                if [ -z "$DEVICE_REVOKED_ACCESS_TYPES" ]; then
                  DEVICE_REVOKED_ACCESS_TYPES="$ACCESS_TYPE_NAME"
                else
                    DEVICE_REVOKED_ACCESS_TYPES="$DEVICE_REVOKED_ACCESS_TYPES, $ACCESS_TYPE_NAME"
                fi  
              elif [ "$HTTP_CODE" = "404" ]; then
                echo "  ‚ÑπÔ∏è Attribute not present: $ATTR"
                SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
              else
                echo "  ‚ùå Failed to revoke $ATTR (HTTP $HTTP_CODE)"
                FAILED_COUNT=$((FAILED_COUNT + 1))
              fi
            done
            
            # Track device with access types revoked
            if [ "$IS_ALL_MODE" = "true" ]; then
              # For all-mode, show attributes per device
              if [ -n "$DEVICE_REVOKED_ACCESS_TYPES" ]; then
                if [ -z "$REVOKED_DEVICES" ]; then
                  REVOKED_DEVICES="$HOSTNAME [$DEVICE_REVOKED_ACCESS_TYPES]"
                else
                  REVOKED_DEVICES="$REVOKED_DEVICES, $HOSTNAME [$DEVICE_REVOKED_ACCESS_TYPES]"
                fi
                echo "::add-mask::$REVOKED_DEVICES"
              fi
            else
              # For single-mode, just list hostnames
              if [ -n "$DEVICE_REVOKED_ACCESS_TYPES" ]; then
                if [ -z "$REVOKED_DEVICES" ]; then
                  REVOKED_DEVICES="$HOSTNAME"
                else
                  REVOKED_DEVICES="$REVOKED_DEVICES, $HOSTNAME"
                fi
                echo "::add-mask::$REVOKED_DEVICES"
              fi
            fi
          done <<< "$ALL_DEVICE_IDS"
          
          echo ""
          echo "üìä Summary:"
          echo "   Revoked: $REVOKED_COUNT"
          echo "   Skipped: $SKIPPED_COUNT"
          echo "   Failed: $FAILED_COUNT"
          
          echo "revoked=$REVOKED_COUNT" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED_COUNT" >> $GITHUB_OUTPUT
          echo "failed=$FAILED_COUNT" >> $GITHUB_OUTPUT
          echo "revoked_devices=$REVOKED_DEVICES" >> $GITHUB_OUTPUT
          
          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "::error::‚ùå Failed to revoke JIT access from $FAILED_COUNT device(s)"
            exit 1
          fi
          
          if [ "$REVOKED_COUNT" -eq 0 ]; then
            echo "::notice::‚ÑπÔ∏è No active JIT access found to revoke"
          else
            echo "::notice::‚úÖ Successfully revoked JIT access from $REVOKED_COUNT attribute(s)"
          fi
          
          exit 0
      
      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "::add-mask::$TELEGRAM_BOT_TOKEN"
          echo "::add-mask::$TELEGRAM_CHAT_ID"
          ACTOR="${{ github.actor }}"
          ACCESS_TYPE="${{ github.event.inputs.access_type }}"

          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "::warning::‚ö†Ô∏è Telegram secrets not configured. Skipping notification."
            echo "::notice::üìñ See README.md for instructions on setting up Telegram notifications."
            exit 0
          fi

          STATUS="${{ job.status }}"
          REVOKED="${{ steps.expire.outputs.revoked }}"
          SKIPPED="${{ steps.expire.outputs.skipped }}"
          FAILED="${{ steps.expire.outputs.failed }}"
          REVOKED_DEVICES="${{ steps.expire.outputs.revoked_devices }}"
          echo "::add-mask::$REVOKED_DEVICES"
          
          if [ -z "$REVOKED_DEVICES" ]; then
            DEVICES_LINE=""
          else
            DEVICES_LINE="%0Aüìã Devices: <code>$REVOKED_DEVICES</code>"
          fi
          
          if [ "$STATUS" = "success" ]; then
            if [ "$ACCESS_TYPE" = "all" ]; then
              MESSAGE='‚úÖ JIT Bulk Revocation <b>COMPLETE</b>%0Aüë§ <code>'$ACTOR'</code>%0Aüîê <b>All Access Types</b>%0A‚úÖ Revoked: '$REVOKED'%0A‚ìò Skipped: '$SKIPPED'%0A‚ùå Failed: '$FAILED''$DEVICES_LINE'%0Aüîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            else
              MESSAGE='‚úÖ JIT Bulk Revocation <b>COMPLETE</b>%0Aüë§ <code>'$ACTOR'</code>%0Aüîê <code>'$ACCESS_TYPE'</code>%0A‚úÖ Revoked: '$REVOKED'%0A‚ìò Skipped: '$SKIPPED'%0A‚ùå Failed: '$FAILED''$DEVICES_LINE'%0Aüîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            fi
          else
            if [ "$ACCESS_TYPE" = "all" ]; then
              MESSAGE='‚ùå JIT Bulk Revocation <b>FAILED</b>%0Aüë§ <code>'$ACTOR'</code>%0Aüîê <b>All Access Types</b>%0A‚úÖ Revoked: '$REVOKED'%0A‚ìò Skipped: '$SKIPPED'%0A‚ùå Failed: '$FAILED''$DEVICES_LINE'%0Aüîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            else
              MESSAGE='‚ùå JIT Bulk Revocation <b>FAILED</b>%0Aüë§ <code>'$ACTOR'</code>%0Aüîê <code>'$ACCESS_TYPE'</code>%0A‚úÖ Revoked: '$REVOKED'%0A‚ìò Skipped: '$SKIPPED'%0A‚ùå Failed: '$FAILED''$DEVICES_LINE'%0Aüîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            fi
          fi
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d "parse_mode=HTML" \
            -d text="$MESSAGE" 2>&1)
          echo "::add-mask::$RESPONSE"
