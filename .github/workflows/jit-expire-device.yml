name: Expire JIT Access (Specific Device)
on:
  workflow_dispatch:
    inputs:
      source_hostname:
        description: 'Source device hostname (e.g., john-laptop)'
        required: true
      access_type:
        description: 'Custom attribute name (without "custom:" prefix) or "all" to revoke all JIT attributes'
        default: 'ssh'
        required: true
        type: choice
        # NOTE: if you update this list, make sure to also update the validation logic in the workflow and the README documentation
        options:
          - ssh
          - arr
          - monitoring
          - admin
          - all

jobs:
  expire-device:
    runs-on: ubuntu-latest
    steps:

      - name: Validate access type and map it into full attribute name
        id: validate-access-type
        run: |

          # validate access type is on the allowed list
          # NOTE: if you updated the list of access types in the workflow_dispatch inputs, make sure to also update this validation logic and the README documentation
          if [[ ! "ssh arr monitoring admin all" =~ "${{ github.event.inputs.access_type }}" ]]; then
            echo "::error::Invalid access type. Must be one of: ssh, arr, monitoring, admin, all."
            exit 1
          fi
          IS_ALL_MODE="false"

          if [ "${{ github.event.inputs.access_type }}" != "all" ]; then
            ATTRIBUTE="custom:${{ github.event.inputs.access_type }}_jit_granted"
          else
            ATTRIBUTE=""
            IS_ALL_MODE="true"
          fi

          echo "attribute=$ATTRIBUTE" >> $GITHUB_OUTPUT
          echo "is_all_mode=$IS_ALL_MODE" >> $GITHUB_OUTPUT
          if [ "$IS_ALL_MODE" = "true" ]; then
            echo "‚úÖ Access type to be revoked: ALL JIT attributes"
          else
            echo "‚úÖ Access type to be revoked: $ATTRIBUTE"
          fi


      - name: Get Tailscale OAuth token
        id: oauth
        env:
          TS_OAUTH_CLIENT_ID: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          TS_OAUTH_CLIENT_SECRET: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
        run: |
          TOKEN_RESPONSE=$(curl -s -X POST \
            "https://api.tailscale.com/api/v2/oauth/token" \
            -d "client_id=$TS_OAUTH_CLIENT_ID" \
            -d "client_secret=$TS_OAUTH_CLIENT_SECRET" \
            -d "scope=devices:core:read devices:posture_attributes")
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          echo "::add-mask::$ACCESS_TOKEN"
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_OUTPUT
          echo "‚úÖ OAuth token obtained"
      
      - name: Lookup source device ID by hostname
        id: source-lookup
        run: |
          # Read hostname directly from the event payload
          # this ensures we don't output it in logs accidentally before masking
          HOSTNAME=$(jq -r '.inputs.source_hostname' "$GITHUB_EVENT_PATH")
          TS_ACCESS_TOKEN="${{ steps.oauth.outputs.access_token }}"

          # Mask hostname in logs
          echo "::add-mask::$HOSTNAME"
          echo "hostname=$HOSTNAME" >> $GITHUB_OUTPUT

          DEVICES=$(curl -s -H "Authorization: Bearer $TS_ACCESS_TOKEN" \
            "https://api.tailscale.com/api/v2/tailnet/-/devices")
          
          SOURCE_DEVICE_ID=$(echo "$DEVICES" | jq -r --arg hostname "$HOSTNAME" \
            '.devices[] | select(
              (.hostname == $hostname) or
              (.name | split(".")[0] == $hostname)
            ) | .id')
          
          if [ "$SOURCE_DEVICE_ID" = "null" ] || [ -z "$SOURCE_DEVICE_ID" ]; then
            echo "::error::‚ùå Device not found. Could not revoke JIT access."
            exit 1
          fi
          
          # Mask device ID in logs
          echo "::add-mask::$SOURCE_DEVICE_ID"
          echo "source_device_id=$SOURCE_DEVICE_ID" >> $GITHUB_OUTPUT
          echo "‚úÖ Found device ID"
      
      - name: Expire JIT access
        id: revoke
        run: |
          ATTRIBUTE="${{ steps.validate-access-type.outputs.attribute }}"
          IS_ALL_MODE="${{ steps.validate-access-type.outputs.is_all_mode }}"
          TS_ACCESS_TOKEN="${{ steps.oauth.outputs.access_token }}"
          SOURCE_DEVICE_ID="${{ steps.source-lookup.outputs.source_device_id }}"
          
          # Build attributes array based on mode
          if [ "$IS_ALL_MODE" = "true" ]; then
            ATTRIBUTES=("custom:ssh_jit_granted" "custom:arr_jit_granted" "custom:monitoring_jit_granted" "custom:admin_jit_granted")
          else
            ATTRIBUTES=("$ATTRIBUTE")
          fi
          
          REVOKED_ATTRS=""
          FAILED_ATTRS=""
          
          # Delete attribute(s)
          for ATTR in "${ATTRIBUTES[@]}"; do
            RESPONSE=$(curl -s -w "%{http_code}" -X DELETE \
              "https://api.tailscale.com/api/v2/device/$SOURCE_DEVICE_ID/attributes/$ATTR" \
              -H "Authorization: Bearer $TS_ACCESS_TOKEN")
            
            HTTP_CODE="${RESPONSE: -3}"
            
            if [ "$HTTP_CODE" = "200" ]; then
              # build a list of revoked attributes
              if [ -z "$REVOKED_ATTRS" ]; then
                REVOKED_ATTRS="$ATTR"
              else
                REVOKED_ATTRS="$REVOKED_ATTRS, $ATTR"
              fi
              # build a list of access types revoked for the notification message by stripping the "custom:" prefix and "_jit_granted" suffix dynamically since we support both single and all mode
              ACCESS_TYPE_NAME=$(echo "$ATTR" | sed -E 's/^custom:(.*)_jit_granted$/\1/')
              if [ -z "$ACCESS_TYPES_REVOKED" ]; then
                ACCESS_TYPES_REVOKED="$ACCESS_TYPE_NAME"
              else
                ACCESS_TYPES_REVOKED="$ACCESS_TYPES_REVOKED, $ACCESS_TYPE_NAME"
              fi
            elif [ "$HTTP_CODE" != "404" ]; then
              if [ -z "$FAILED_ATTRS" ]; then
                FAILED_ATTRS="$ATTR"
              else
                FAILED_ATTRS="$FAILED_ATTRS, $ATTR"
              fi
            fi
          done
          
          if [ -z "$REVOKED_ATTRS" ] && [ -n "$FAILED_ATTRS" ]; then
            echo "::error::‚ùå Failed to revoke JIT attributes: $FAILED_ATTRS"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ JIT access REVOKED!"
          echo "revoked_attributes=$REVOKED_ATTRS" >> $GITHUB_OUTPUT
          echo "access_types_revoked=$ACCESS_TYPES_REVOKED" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          
          echo "::add-mask::$TELEGRAM_BOT_TOKEN"
          echo "::add-mask::$TELEGRAM_CHAT_ID"

          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "::warning::‚ö†Ô∏è Telegram secrets not configured. Skipping notification."
            echo "::notice::üìñ See README.md for instructions on setting up Telegram notifications."
            exit 0
          fi

          HOSTNAME="${{ steps.source-lookup.outputs.hostname }}"
          SOURCE_DEVICE_ID="${{ steps.source-lookup.outputs.source_device_id }}"

          ACTOR="${{ github.actor }}"
          ACCESS_TYPE="${{ github.event.inputs.access_type }}"
          ACCESS_TYPES_REVOKED="${{ steps.revoke.outputs.access_types_revoked }}"

          STATUS="${{ job.status }}"
          REVOKE_SUCCESS="${{ steps.revoke.outputs.success }}"
          if [ "$STATUS" = "success" ] && [ "$REVOKE_SUCCESS" = "true" ]; then
            if [ "$ACCESS_TYPE" = "all" ] && [ -n "$ACCESS_TYPES_REVOKED" ]; then
              MESSAGE='‚úÖ JIT Access <b>REVOKED</b>%0Aüë§ <code>'$ACTOR'</code>%0Aüîê <b>All Access Types</b>%0Aüìã <code>'$ACCESS_TYPES_REVOKED'</code>%0Aüíª <code>'$HOSTNAME' ('$SOURCE_DEVICE_ID')</code>%0Aüîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            else
              MESSAGE='‚úÖ JIT Access <b>REVOKED</b>%0Aüë§ <code>'$ACTOR'</code>%0Aüîê <code>'$ACCESS_TYPE'</code>%0Aüíª <code>'$HOSTNAME' ('$SOURCE_DEVICE_ID')</code>%0Aüîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            fi
          else
            MESSAGE='‚ùå Revocation <b>FAILED</b>%0Aüë§ <code>'$ACTOR'</code>%0Aüîê <code>'$ACCESS_TYPE'</code>%0Aüíª <code>'$HOSTNAME' ('$SOURCE_DEVICE_ID')</code>%0Aüîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          fi
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d "parse_mode=HTML" \
            -d text="$MESSAGE" 2>&1)
          echo "::add-mask::$RESPONSE"
